// Viral Dashboard - PostgreSQL Schema
// Multi-tenant SaaS architecture with Neon Serverless PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Neon connection pooling support
}

// ============================================================
// USER & TENANT MANAGEMENT
// ============================================================

model User {
  id            String   @id @default(uuid())
  clerkId       String   @unique
  email         String   @unique
  name          String?
  imageUrl      String?
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role          UserRole @default(MEMBER)
  apiKey        String?  @unique
  apiKeyHash    String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  @@index([clerkId])
  @@index([tenantId])
  @@index([apiKey])
  @@map("users")
}

enum UserRole {
  ADMIN
  MEMBER
}

model Tenant {
  id                  String   @id @default(uuid())
  name                String
  subscriptionTier    SubscriptionTier @default(FREE)
  subscriptionStatus  String   @default("active") // active, canceled, past_due
  stripeCustomerId    String?  @unique
  stripeSubscriptionId String? @unique
  monthlyQuota        Int      @default(10) // concepts per month
  usedQuota           Int      @default(0)
  quotaResetAt        DateTime
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  users               User[]
  generations         Generation[]
  videos              Video[]
  socialAccounts      SocialAccount[]
  performanceMetrics  PerformanceFeedback[]
  critiques           SelfCritique[]
  insights            ReflexionInsight[]
  adjustments         ScoringAdjustment[]

  @@index([stripeCustomerId])
  @@map("tenants")
}

enum SubscriptionTier {
  FREE
  STARTER  // $49/month - 10 concepts
  PRO      // $149/month - 50 concepts
  AGENCY   // $499/month - 500 concepts
}

// ============================================================
// VIRAL CONTENT GENERATION
// ============================================================

model Generation {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date        DateTime @default(now())
  concepts    Json     // ViralConcept[]
  trends      Json     // TrendData[]
  isFavorite  Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([tenantId, date])
  @@index([tenantId, isFavorite])
  @@map("generations")
}

model Video {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conceptId     String
  category      String
  platform      String   // tiktok, youtube-shorts, instagram-reels
  videoUrl      String   // S3 original
  cdnUrl        String?  // CloudFront CDN
  thumbnailUrl  String?
  provider      String   // sora, veo, runway
  status        String   @default("generating") // generating, completed, failed
  errorMessage  String?
  metadata      Json?    // generation settings, quality scores, keyframes
  generationCost Decimal @db.Decimal(10, 4) @default(0)
  generatedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([tenantId, status])
  @@index([conceptId])
  @@index([platform])
  @@map("videos")
}

// ============================================================
// SOCIAL MEDIA MANAGEMENT
// ============================================================

model SocialAccount {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  platform      String   // tiktok, youtube, instagram
  username      String
  accessToken   String   // encrypted
  refreshToken  String?  // encrypted
  expiresAt     DateTime?
  dailyLimit    Int      @default(10)
  usedToday     Int      @default(0)
  lastReset     DateTime @default(now())
  niche         String?  // category-specific accounts
  isActive      Boolean  @default(true)
  metadata      Json?    // platform-specific data
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  posts         SocialPost[]

  @@unique([tenantId, platform, username])
  @@index([platform, isActive])
  @@map("social_accounts")
}

model SocialPost {
  id              String   @id @default(uuid())
  videoId         String
  accountId       String
  account         SocialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  platform        String
  postUrl         String?
  platformPostId  String?
  status          String   @default("pending") // pending, posted, failed
  errorMessage    String?
  scheduledFor    DateTime?
  postedAt        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([videoId])
  @@index([accountId, status])
  @@index([platform, postedAt])
  @@map("social_posts")
}

// ============================================================
// PERFORMANCE TRACKING
// ============================================================

model PerformanceFeedback {
  id               String   @id @default(uuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conceptId        String
  conceptTitle     String
  category         String
  platform         String
  variantId        String?
  views            Int
  likes            Int
  shares           Int
  comments         Int
  engagementRate   Decimal  @db.Decimal(10, 4)
  reportedAt       DateTime @default(now())
  dataSource       String   @default("manual") // manual, scraped, api

  @@index([tenantId, category])
  @@index([conceptId])
  @@index([platform, reportedAt])
  @@map("performance_feedback")
}

model AnalyticsSnapshot {
  id              String   @id @default(uuid())
  videoId         String
  platform        String
  views           Int
  likes           Int
  shares          Int
  comments        Int
  watchTime       Int?     // seconds
  engagementRate  Decimal  @db.Decimal(10, 4)
  snapshotAt      DateTime @default(now())

  @@index([videoId, snapshotAt])
  @@index([platform, snapshotAt])
  @@map("analytics_snapshots")
}

// ============================================================
// REFLEXION SYSTEM - Self-Learning AI
// ============================================================

model SelfCritique {
  id                   String   @id @default(uuid())
  tenantId             String
  tenant               Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  conceptId            String
  performanceGap       Json     // PerformanceGap object
  critique             String   @db.Text
  hypothesizedReasons  Json     // string[]
  scoringIssues        Json     // string[]
  adjustmentPlan       String   @db.Text
  confidenceLevel      String   // low, medium, high
  createdAt            DateTime @default(now())
  appliedAt            DateTime?

  adjustments          ScoringAdjustment[]

  @@index([tenantId, createdAt])
  @@index([conceptId])
  @@index([confidenceLevel])
  @@map("self_critiques")
}

model ReflexionInsight {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category          String
  platform          String
  pattern           String   @db.Text
  evidenceCount     Int      @default(1)
  impact            String   // positive, negative, neutral
  recommendation    String   @db.Text
  appliedToScoring  Boolean  @default(false)
  discoveredAt      DateTime @default(now())
  lastSeenAt        DateTime @default(now())

  @@unique([tenantId, category, platform, pattern])
  @@index([tenantId, appliedToScoring])
  @@map("reflexion_insights")
}

model ScoringAdjustment {
  id             String   @id @default(uuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  critiqueId     String
  critique       SelfCritique @relation(fields: [critiqueId], references: [id], onDelete: Cascade)
  category       String
  adjustmentType String   // category-weight, hook-effectiveness, platform-multiplier, recency-boost
  oldValue       Decimal  @db.Decimal(10, 4)
  newValue       Decimal  @db.Decimal(10, 4)
  reason         String   @db.Text
  appliedAt      DateTime @default(now())

  @@index([tenantId, category])
  @@index([critiqueId])
  @@map("scoring_adjustments")
}

// ============================================================
// AUDIO & COMPETITOR TRENDS (Phase 4)
// ============================================================

model AudioTrend {
  id            String   @id @default(uuid())
  platform      String   // tiktok, instagram
  soundId       String
  soundName     String
  artistName    String?
  usageCount    Int
  trendScore    Decimal  @db.Decimal(10, 4)
  category      String?
  discoveredAt  DateTime @default(now())
  lastSeenAt    DateTime @default(now())
  isActive      Boolean  @default(true)

  @@unique([platform, soundId])
  @@index([platform, trendScore])
  @@map("audio_trends")
}

model CompetitorVideo {
  id              String   @id @default(uuid())
  platform        String
  creatorUsername String
  category        String
  videoId         String
  title           String?
  views           Int
  likes           Int
  comments        Int
  engagementRate  Decimal  @db.Decimal(10, 4)
  duration        Int      // seconds
  hashtags        Json?    // string[]
  soundId         String?
  hookText        String?  @db.Text
  publishedAt     DateTime
  scrapedAt       DateTime @default(now())

  @@unique([platform, videoId])
  @@index([category, engagementRate])
  @@map("competitor_videos")
}

// ============================================================
// JOB QUEUE & SYSTEM MONITORING
// ============================================================

model JobQueue {
  id              String   @id @default(uuid())
  tenantId        String?
  jobType         String   // generate-video, post-to-platform, scrape-analytics
  status          String   @default("pending") // pending, running, completed, failed
  priority        Int      @default(5)
  payload         Json
  result          Json?
  errorMessage    String?  @db.Text
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)
  scheduledFor    DateTime @default(now())
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime @default(now())

  @@index([status, priority, scheduledFor])
  @@index([jobType, status])
  @@map("job_queue")
}

model SystemMetrics {
  id                    String   @id @default(uuid())
  metricType            String   // video_generation_rate, posting_success_rate, reflexion_accuracy, cost_per_video
  value                 Decimal  @db.Decimal(10, 4)
  metadata              Json?
  recordedAt            DateTime @default(now())

  @@index([metricType, recordedAt])
  @@map("system_metrics")
}

model ApiUsage {
  id            String   @id @default(uuid())
  tenantId      String
  apiKey        String
  endpoint      String
  method        String
  statusCode    Int
  responseTime  Int      // milliseconds
  timestamp     DateTime @default(now())

  @@index([tenantId, timestamp])
  @@index([apiKey, timestamp])
  @@map("api_usage")
}
